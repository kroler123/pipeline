#!groovy
// Check properties
properties([disableConcurrentBuilds()])

pipeline {
	agent {
		label 'master'
	}
	parameters {
		string(name: 'SALON', defaultValue: 'null')
	}
	options {
		buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
		timestamps()
		skipStagesAfterUnstable()
	}
	stages {
                stage("Настройка маршрутизации") {
                        steps {
				script {
					GET_SALON = sh (
						script: 'echo 10.20.' + params.SALON + '.6',
						returnStdout: true
					).trim()
					sh ( script: 'ssh-keygen -f "/var/lib/jenkins/.ssh/known_hosts" -R ' + GET_SALON )
					GET_LOCALIP = sh (
						script: 'ip a | grep 10.20.' + params.SALON + ' | awk \'{print $2}\'',
						returnStdout: true
					).trim()
					GET_IPM = sh (
						script: 'echo 10.20.' + params.SALON + '.100/24',
						returnStdout: true
					).trim()
					GET_GWIP = sh (
						script: 'echo 10.20.' + params.SALON + '.1/24',
						returnStdout: true
					).trim()
					if (GET_LOCALIP != GET_IPM) {
						sh ( script: 'sudo ip a add 10.20.' + params.SALON + '.100/24 dev ens32' )
					}
					GET_TEST = sh (
						script: 'ssh -o "StrictHostKeyChecking=no" -i /var/lib/jenkins/.ssh/id_rsa root@192.168.99.168 "ip a" | grep 10.20.' + params.SALON + ' | awk \'{print $2}\'',
						returnStdout: true
					).trim()
					if (GET_TEST != GET_GWIP) {
						sh ( script: 'ssh -o "StrictHostKeyChecking=no" -i /var/lib/jenkins/.ssh/id_rsa root@192.168.99.168 ip a add 10.20.' + params.SALON + '.1/24 dev vmbr0')
						sh ( script: 'ssh -o "StrictHostKeyChecking=no" -i /var/lib/jenkins/.ssh/id_rsa root@192.168.99.168 iptables -A FORWARD -o vmbr0 -s 10.20.' + params.SALON + '.0/24 -j ACCEPT')
						sh ( script: 'ssh -o "StrictHostKeyChecking=no" -i /var/lib/jenkins/.ssh/id_rsa root@192.168.99.168 iptables -A FORWARD -i vmbr0 -d 10.20.' + params.SALON + '.0/24 -j ACCEPT')
						sh ( script: 'ssh -o "StrictHostKeyChecking=no" -i /var/lib/jenkins/.ssh/id_rsa root@192.168.99.168 iptables -t nat -A FORWARD -o vmbr0 -s 10.20.' + params.SALON + '.0/24 -j MASQUERADE')
					}
				}
				echo "$GET_LOCALIP and $GET_IPM"
			}
		}
	}
}
